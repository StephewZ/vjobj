<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <title>Document</title>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js">
    </script>
</head>
<body>
	<div class="device">123</div>
	<button id="pay" onclick="pay()">支付0.01 {{ code }}</button>
  <div id="code">{{ code }}</div>
</body>
</html>
<script type="text/javascript">
	var Ajax={
    get: function(url, fn) {
        var xhr = new XMLHttpRequest();  
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200 || xhr.status == 304) {
              console.log(xhr.responseText)
              console.log(this)
              fn.call(this, xhr.responseText);
            }
        };
        xhr.send();
    },
    post: function (url, data, fn) {       
        var xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) { 
                fn.call(this, xhr.responseText);
            }
        };
        xhr.send(data);
    }
	}
  
	var url = '/paydetail'
	function onBridgeReady(){
		Ajax.get(url + "?code=" + document.getElementById('code').innerText, function(res) {
 			var jsonobj = JSON.parse(res)
    WeixinJSBridge.invoke('getBrandWCPayRequest', {
      'appId': jsonobj.appId, 
      'timeStamp': jsonobj.timeStamp,
      'nonceStr': jsonobj.nonceStr,
      'package': jsonobj.package,
      'signType': jsonobj.signType,
      'paySign': jsonobj.paySign
    }, function(res) {
      if (res.err_msg == "get_brand_wcpay_request:ok") {  
        window.location.href('/pay/payback_url')
      } else {
        alert('错误:' + res.err_msg);
      }  
      alert(JSON.stringify(res));
              
    });

    })
	}

	function pay(){
    // Ajax.get(url + "?code=0610DqW30jfH5E1cunU30MJIW300DqWo", function(res) {
    //   var jsonobj = JSON.parse(res)
    //   alert(jsonobj.paySign)
    // })
		if (typeof WeixinJSBridge=="undefined") {
		  if (document.addEventListener) {
		    document.addEventListener('WeixinJSBridgeReady',onBridgeReady,false);  
		  } else if (document.attachEvent) { 
		    document.attachEvent('WeixinJSBridgeReady',onBridgeReady);  
		    document.attachEvent('onWeixinJSBridgeReady',onBridgeReady);  
		  }  
		} else {
		  onBridgeReady();  
		} 
	} 
</script>