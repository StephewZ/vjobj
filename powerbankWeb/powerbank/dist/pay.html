<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <title>Document</title>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js">
    </script>
</head>
<body>
	<div class="device">123</div>
	<button id="pay" onclick="pay()">支付0.01 {{ code }}</button>
</body>
</html>
<script type="text/javascript">
	var Ajax={
    get: function(url, data, fn) {
        var xhr = new XMLHttpRequest();  
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200 || xhr.status == 304) {
                fn.call(this, xhr.responseText);
            }
        };
        xhr.send(data);
    },
    post: function (url, data, fn) {       
        var xhr = new XMLHttpRequest();
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) { 
                fn.call(this, xhr.responseText);
            }
        };
        xhr.send(data);
    }
	}
  
	var url = '/paydetail'
	function onBridgeReady(){
    alert(code)
		Ajax.get(url, {'device': 123789, 'code': '{{ code }}'}, function(res) {
 			console.log(res)
 			var jsonobj = eval('('+res+')');
		alrt(jsonobj)
    WeixinJSBridge.invoke('getBrandWCPayRequest', {
      'appId': jsonobj.appId, 
      'timeStamp': jsonobj.timestamp,
      'nonceStr': jsonobj.nonceStr,
      'package': jsonobj.package,
      'signType': 'MD5',
      'paySign': jsonobj.paySign
    }, function(res) {
      if (res.err_msg == "get_brand_wcpay_request:ok") {  
        alert(res.err_msg)
      } else {
        alert('错误:' + res.err_msg);
      }  
      alert(res.err_msg);  
              
    });

    })
	}

	function pay(){
    Ajax.post(url, {'device': 123789}, function(res) {
      console.log(res)
    })
		if (typeof WeixinJSBridge=="undefined") {
		  if (document.addEventListener) {
		    document.addEventListener('WeixinJSBridgeReady',onBridgeReady,false);  
		  } else if (document.attachEvent) { 
		    document.attachEvent('WeixinJSBridgeReady',onBridgeReady);  
		    document.attachEvent('onWeixinJSBridgeReady',onBridgeReady);  
		  }  
		} else {
		  onBridgeReady();  
		} 
	} 
</script>